<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="icon" href="./assets/kazoo.png">
    <title>KazooGuesser</title>
  </head>
  <body
    class="container-fluid"
    style="padding-top: 10px; padding-left: 40px; padding-right: 40px"
  >
    <div class="header container-fluid" id="game-header">
      <h1 style="vertical-align: bottom">kazuub.io</h1>
    </div>
    <div class="page container-fluid">
      <div class="game-section container-fluid col-4" id="players">
        <div class="game-section-header">
          <h2>players</h2>
        </div>
        <li id="playerList" style="list-style-type: none;"></li>
      </div>
      <div class="game-section container-fluid col-4" id="music">
        <div class="game-section-header">
          <h2>music</h2>
        </div>
        <img
          src="https://e7.pngegg.com/pngimages/439/430/png-clipart-musical-note-eighth-note-miscellaneous-music-symbols.png"
          alt=""
          width="400px"
          height="400px"
        />
        <audio
          id="song"
          src="https://cdns-preview-d.dzcdn.net/stream/c-deda7fa9316d9e9e880d2c6207e92260-8.mp3"
        ></audio>
        <input type="button" value="PLAY" onclick="playSong()" />
      </div>
      <div class="game-section container-fluid col-4" id="chat">
        <div class="game-section-header">
          <h2>chat</h2>
        </div>
        <ul id="messages" style="list-style-type: none;"></ul>
        <form class="text-entry" id="sendChat">
          <input id="messageInput" placeholder="enter your guess here" autocomplete="off"/>
          <button>Send</button>
        </form>
      </div>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script>

    // Page state
    const roomId = '<%=roomId%>';
    const username = '<%=username%>';
    const userId = '<%=userId%>';
    const userInfo = {
      username: username,
      userId: userId,
    };

    // Socket setup
    const socket = io();

    socket.on('receive', (data) => {
      console.log(data);
      const chatText = `<b>${data.userInfo.username}</b>: ${data.message}`;
      $("#messages").append($("<li>").html(chatText));
    });

    const setupSockets = () => {
      socket.emit('joinRoom', {
        userInfo: userInfo,
        roomId: roomId,
      });
    };

    $('form#sendChat').submit((e) => {
      console.log('chat submitted');
      e.preventDefault(); // Prevents page reloading
      const message = $('#messageInput').val();
      if (!message) { return; }
      
      // Send message to room
      socket.emit('send', {
        userInfo: userInfo,
        roomId: roomId,
        message: message,
      });

      console.log({
        userInfo: userInfo,
        roomId: roomId,
        message: message,
      });

      $('#messageInput').val('');
    });

    function sortByScore(a, b) {
      if (a.score > b.score) {
        return -1;
      } else if (b.score > a.score) {
        return 1;
      } else {
        return 0;
      }
    }

    var players = [
      { name: "mac", score: 10},
      { name: "marcos", score: 7 },
      { name: "riley", score: 4 },
      { name: "efe", score: 12 },
    ];

    players.sort(sortByScore);
    var playerList = document.getElementById("playerList");
    players.forEach(player => {
        var playerCard = document.createElement("div");
        playerCard.className = "player-card";

        var playerAvatar = document.createElement("img");
        playerAvatar.id = "player-avatar";
        playerAvatar.src = "https://icon-library.com/images/male-avatar-icon/male-avatar-icon-14.jpg";

        var playerName = document.createElement("h3");
        playerName.innerHTML = player.name;
        playerName.id = "player-name";

        var playerScore = document.createElement("h3");
        playerScore.innerHTML = player.score;
        playerScore.id = "player-score";

        playerCard.appendChild(playerAvatar);
        playerCard.appendChild(playerName);
        playerCard.appendChild(playerScore);
        playerList.appendChild(playerCard);
    });

    function playSong() {
      var song = document.getElementById("song");
      song.play();
    }

    $('document').ready(() => {
      setupSockets();
    });

  </script>
</html>
